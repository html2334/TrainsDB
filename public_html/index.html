<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TrainsDB</title>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">
  <meta property="og:image:alt" content="">
  <link rel="manifest" href="../site.webmanifest">
  <meta name="theme-color" content="#fafafa">
  <style>
    .topbar {
      background-color: #2a3760;
      padding: 5px 3px;
      border: 4px solid orange;
    }
    .topbar a, .topbar button {
      font-family: sans-serif;
      text-decoration: none;
      font-weight: bold;
      padding: 10px 15px;
      display: inline-block;
      white-space-collapse: discard;
      color: #eeeeee;
      border-radius: 7px;
      border: 2px solid #aaaaaa;
    }
  </style>
  <script src="index.js"></script>
  <script src="luxon.js"></script>
  <script>
    function grab(input) {
      const selectStation = document.getElementById("selectStation")
      const relevantStation = document.getElementById("relevantStation")
      selectStation.innerHTML = ''
      relevantStation.innerText = ''
      input.forEach(station => {
        const li = document.createElement('li');
        const button = document.createElement('button');
        button.textContent = station
        li.appendChild(button)
        selectStation.appendChild(li)
      })
    }
  </script>
</head>

<body>
  <h1>Select a train line and station to see departures</h1>
  <div class="topbar">
    <button onClick="grab(window.m1)" style="background-color:#168388;">M1</button>
    <a style="border: none;"></a>
    <button onClick="grab(window.t1)" style="background-color:#f99d1c;color: #aaaaaa;">T1</button>
    <button onClick="grab(window.t2)" style="background-color:#0098cd;">T2</button>
    <button onClick="grab(window.t3)" style="background-color:#f37021;">T3</button>
    <button onClick="grab(window.t4)" style="background-color:#005aa3;">T4</button>
    <button onClick="grab(window.t5)" style="background-color:#c4258f;">T5</button>
    <button onClick="grab(window.t6)" style="background-color:#7d3f21;">T6</button>
    <button onClick="grab(window.t7)" style="background-color:#6f818e;">T7</button>
    <button onClick="grab(window.t8)" style="background-color:#00954c;">T8</button>
    <button onClick="grab(window.t9)" style="background-color:#d11f2f;">T9</button>
    <a style="border: none;"></a>
    <button onClick="grab(window.bmt)" style="background-color:#f99d1c;color:#aaaaaa;">BMT</button>
    <button onClick="grab(window.ccn)" style="background-color:#d11f2f;">CCN</button>
    <button onClick="grab(window.hun)" style="background-color:#833134;">HUN</button>
    <button onClick="grab(window.sco)" style="background-color:#005aa3;">SCO</button>
    <button onClick="grab(window.shl)" style="background-color:#008846;">SHL</button>
  </div>
<h1 id="relevantStation"></h1>
<ul id="selectStation"></ul>
<ul id="timetable"></ul>

<script>
  var DateTime = luxon.DateTime
  const ul = document.getElementById("selectStation")
  ul.addEventListener("click", async function (event) {
    const btn = event.target.closest("button")
    if ((!btn) || btn.innerText.includes("BRANCH") || (btn.innerText === '')) return
    await fetch("http://localhost:8081/getID?name=" + btn.innerText)
      .then(res => {
        return res.text()
      })
      .then(payload => {
        window.stopID = payload
      })
    const stopID = window.stopID
    const departures = await fetch(`http://localhost:8081/departures?station=${stopID}`)
    const res = await departures.json()
    console.log(res)
    const selectStation = document.getElementById("selectStation")
    const timetable = document.getElementById("timetable")
    const relevantStation = document.getElementById("relevantStation")
    relevantStation.innerText = btn.innerText
    selectStation.innerHTML = ''
    res.stopEvents.forEach(train => {
      const li = document.createElement('li')
      const h2 = document.createElement('h2')
      const ul = document.createElement('ul')
      const time = document.createElement('li')
      if (train.isRealtimeControlled) {
        time.innerText = DateTime.fromISO(train.departureTimeEstimated).setZone('Australia/Sydney').toRelative({ style: "short"})
      } else {
        time.innerText = DateTime.fromISO(train.departureTimePlanned).setZone('Australia/Sydney').toRelative({ style: "short"})
      }
      h2.textContent = `${train.transportation.disassembledName} ${train.transportation.description}`
      li.appendChild(h2)
      ul.appendChild(time)
      li.appendChild(ul)
      selectStation.appendChild(li)
      console.log(li.textContent)


    })
  })
</script>
</body>

</html>
